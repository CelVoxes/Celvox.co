---
title: "debug"
author: "EOK"
date: "2024-10-16"
output: html_document
---

```{r}
library(FNN)

# Set the working directory to the backend folder
setwd("backend")

# Verify the working directory has been changed
cat("Current working directory:", getwd(), "\n")

# Optionally, list files in the new working directory to confirm
cat("Files in the current directory:\n")
print(list.files())

source("plumber.R")
```

```{r}
corrected <- readRDS("backend/cache/normalized_and_corrected_matrix.rds")
# selected most variable 2000 genes
vars <- apply(corrected, 1, var)
corrected_2000 <- corrected[names(vars[order(vars, decreasing = T)[1:2000]]), ]
```


```{r}
library(FNN)

knn_result <- FNN::get.knn(corrected_2000, k = 10)

knn_indices <- knn_result$nn.index
knn_distances <- knn_result$nn.dist

knn_df <- data.frame(
    sample_id = colnames(corrected_2000),
    knn_indices = knn_indices,
    knn_distances = knn_distances
)
```
```{r}
library(data.table)
    uncorrected <- fread("backend/data/counts/uncorrected_counts.csv", data.table = F)
    sample_data <- readRDS("backend/cache/sample_data.rds")
```


```{r}
library(seAMLess)
library(Biobase)
seAMLess(sample_data)
```
```{r}

gene_index =2
norm.mat <-fread("/Users/onur-lumc/Desktop/seamless/backend/data/counts/normalised_and_corrected_counts.csv", 
                   select = c(1, gene_index + 1),  # +1 because the first column is gene names
                       data.table = FALSE)

    # Read only the sample IDs and the requested gene column
    gene_data <- fread("/Users/onur-lumc/Desktop/seamless/backend/data/counts/normalised_and_corrected_counts.csv", 
                       select = c(1, gene_index),
                       col.names = c("sample_id", "expression"),
                       data.table = FALSE)

norm.mat <-fread("/Users/onur-lumc/Desktop/seamless/backend/data/counts/normalised_and_corrected_counts.csv", data.table = FALSE)

norm.mat2 <- readRDS("/Users/onur-lumc/Desktop/seamless/backend/cache/normalized_and_corrected_matrix.rds")
```
```{r}
norm.fst <- read_fst('backend/cache/normalized_and_corrected_matrix.fst')

write_fst(norm.fst, path = "/Users/onur-lumc/Desktop/data.fst")\


tsne_df <- read_fst("backend/cache/tsne_result.fst")

 rownames(tsne_df) <- tsne_df[, 1]
tsne_df <- tsne_df[, -1, drop = FALSE]
```

```{r}

example.tcga <- read.csv("/Users/onur-lumc/Desktop/exampleTCGA.csv")
```
```{r}
library(fst)

sample.fst <-read_fst("backend/cache/sample_data.fst")

sample.fst <- sample.fst[!grepl("__no_feature|__ambiguous", rownames(sample.fst)), ]
```


```{r}
setwd("backend/")

library(fst)
library(limma)
library(data.table)

source("backend/plumber.R")

# Get parameters from request
k <-20
sample_id <- "TCGA.AB.3011.03A_sample_data"

if (is.null(sample_id)) {
    return(list(error = "Sample ID is required"))
}
# Get the harmonized data
corrected <- read_fst("backend/cache/harmonized_data.fst")
rownames(corrected) <- corrected[, 1]
corrected <- corrected[, -1, drop = FALSE]

# Get KNN results for the selected sample
knn_result <- FNN::get.knn(t(corrected), k = k)

# Find the index of the selected sample
sample_idx <- which(colnames(corrected) == sample_id)
if (length(sample_idx) == 0) {
    return(list(error = "Sample not found"))
}

# Get the neighbors for the selected sample
neighbors <- knn_result$nn.index[sample_idx, ]

# Create contrast vector for limma
# Create a factor with the target sample and its neighbors vs background
group <- factor(ifelse(1:ncol(corrected) == sample_idx, "target",
                      ifelse(1:ncol(corrected) %in% neighbors, "neighbor", "background")))
    
    # Create design matrix
    design <- model.matrix(~0 + group)
    colnames(design) <- levels(group)
    
    # Define contrasts of interest
    contrast.matrix <- makeContrasts(
        target_vs_background = target - background,
        neighbor_vs_background = neighbor - background,
        target_vs_neighbor = target - neighbor,
        levels = design
    )
    
    # Fit the model and calculate statistics
    fit <- lmFit(corrected, design)
    fit <- contrasts.fit(fit, contrast.matrix)
    fit <- eBayes(fit, trend=TRUE)
    
    # Get results for all contrasts
    results <- list(
        target_vs_background = topTable(fit, coef=1, number=Inf),
        neighbor_vs_background = topTable(fit, coef=2, number=Inf),
        target_vs_neighbor = topTable(fit, coef=3, number=Inf)
    )


```


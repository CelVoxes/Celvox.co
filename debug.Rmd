---
title: "debug"
author: "EOK"
date: "2024-10-16"
output: html_document
---

```{r}
library(FNN)

# Set the working directory to the backend folder
setwd("backend")

# Verify the working directory has been changed
cat("Current working directory:", getwd(), "\n")

# Optionally, list files in the new working directory to confirm
cat("Files in the current directory:\n")
print(list.files())

source("plumber.R")
```

```{r}
corrected <- readRDS("backend/cache/normalized_and_corrected_matrix.rds")
# selected most variable 2000 genes
vars <- apply(corrected, 1, var)
corrected_2000 <- corrected[names(vars[order(vars, decreasing = T)[1:2000]]), ]
```


```{r}
library(FNN)

knn_result <- FNN::get.knn(corrected_2000, k = 10)

knn_indices <- knn_result$nn.index
knn_distances <- knn_result$nn.dist

knn_df <- data.frame(
    sample_id = colnames(corrected_2000),
    knn_indices = knn_indices,
    knn_distances = knn_distances
)
```
```{r}
library(data.table)
    uncorrected <- fread("backend/data/counts/uncorrected_counts.csv", data.table = F)
    sample_data <- readRDS("backend/cache/sample_data.rds")
```


```{r}
library(seAMLess)
library(Biobase)
seAMLess(sample_data)
```
```{r}

gene_index =2
norm.mat <-fread("/Users/onur-lumc/Desktop/seamless/backend/data/counts/normalised_and_corrected_counts.csv", 
                   select = c(1, gene_index + 1),  # +1 because the first column is gene names
                       data.table = FALSE)

    # Read only the sample IDs and the requested gene column
    gene_data <- fread("/Users/onur-lumc/Desktop/seamless/backend/data/counts/normalised_and_corrected_counts.csv", 
                       select = c(1, gene_index),
                       col.names = c("sample_id", "expression"),
                       data.table = FALSE)

norm.mat <-fread("/Users/onur-lumc/Desktop/seamless/backend/data/counts/normalised_and_corrected_counts.csv", data.table = FALSE)

norm.mat2 <- readRDS("/Users/onur-lumc/Desktop/seamless/backend/cache/normalized_and_corrected_matrix.rds")
```
```{r}
norm.fst <- read_fst('backend/cache/normalized_and_corrected_matrix.fst')

write_fst(norm.fst, path = "/Users/onur-lumc/Desktop/data.fst")\


tsne_df <- read_fst("backend/cache/tsne_result.fst")

 rownames(tsne_df) <- tsne_df[, 1]
tsne_df <- tsne_df[, -1, drop = FALSE]
```

```{r}

example.tcga <- read.csv("/Users/onur-lumc/Desktop/exampleTCGA.csv")
```

```{r}
library(fst)

sample.fst <-read_fst("backend/cache/sample_data.fst")

sample.fst <- sample.fst[!grepl("__no_feature|__ambiguous", rownames(sample.fst)), ]
```


```{r}
setwd("backend/")

library(fst)
library(limma)
library(data.table)

source("backend/plumber.R")

# Get parameters from request
k <-20
sample_id <- "TCGA.AB.3011.03A_sample_data"

if (is.null(sample_id)) {
    return(list(error = "Sample ID is required"))
}
# Get the harmonized data
corrected <- read_fst("backend/cache/harmonized_data.fst")
rownames(corrected) <- corrected[, 1]
corrected <- corrected[, -1, drop = FALSE]

# Get KNN results for the selected sample
knn_result <- FNN::get.knn(t(corrected), k = k)

# Find the index of the selected sample
sample_idx <- which(colnames(corrected) == sample_id)
if (length(sample_idx) == 0) {
    return(list(error = "Sample not found"))
}

# Get the neighbors for the selected sample
neighbors <- knn_result$nn.index[sample_idx, ]

# Create contrast vector for limma
# Create a factor with the target sample and its neighbors vs background
group <- factor(ifelse(1:ncol(corrected) == sample_idx, "target",
                      ifelse(1:ncol(corrected) %in% neighbors, "neighbor", "background")))
    
    # Create design matrix
    design <- model.matrix(~0 + group)
    colnames(design) <- levels(group)
    
    # Define contrasts of interest
    contrast.matrix <- makeContrasts(
        target_vs_background = target - background,
        neighbor_vs_background = neighbor - background,
        target_vs_neighbor = target - neighbor,
        levels = design
    )
    
    # Fit the model and calculate statistics
    fit <- lmFit(corrected, design)
    fit <- contrasts.fit(fit, contrast.matrix)
    fit <- eBayes(fit, trend=TRUE)
    
    # Get results for all contrasts
    results <- list(
        target_vs_background = topTable(fit, coef=1, number=Inf),
        neighbor_vs_background = topTable(fit, coef=2, number=Inf),
        target_vs_neighbor = topTable(fit, coef=3, number=Inf)
    )


```

```{r}
 is_ensembl <- function(ids) {
    ensembl_count <- sum(grepl("^ENSG", ids))
    ensembl_percentage <- ensembl_count / length(ids) * 100
    return(ensembl_percentage > 95)
}

# Check for gene IDs in both rownames and first column
check_gene_ids <- function(data) {
    # Check if rownames are not just numbers
    rowname_is_gene <- !all(grepl("^\\d+$", rownames(data)))

    # Check if the first column contains potential gene IDs
    first_col_is_gene <- is.character(data[[1]]) && !all(grepl("^\\d+$", data[[1]]))

    if (rowname_is_gene && first_col_is_gene) {
        message("Gene IDs found in both rownames and first column.")
        return(list(gene_ids = rownames(data), id_in_column = TRUE))
    } else if (rowname_is_gene) {
        message("Gene IDs are in rownames")
        return(list(gene_ids = rownames(data), id_in_column = FALSE))
    } else if (first_col_is_gene) {
        message("Gene IDs are in the first column")
        return(list(gene_ids = data[[1]], id_in_column = TRUE))
    } else {
        message("No gene IDs found in rownames or first column")
        return(NULL)
    }
}

# Function to strip version numbers from Ensembl IDs
strip_ensembl_version <- function(ids) {
    gsub("\\.[0-9]+$", "", ids)
}

convert_to_symbols <- function(data) {
    # Check if gene IDs are in the first column or rownames
    id_info <- check_gene_ids(data)

    if (!is.null(id_info)) {
        gene_ids <- id_info$gene_ids
        id_in_column <- id_info$id_in_column
    } else {
        message("Unable to determine gene ID location. Please check your data format.")
        return(NULL)
    }

    # Calculate variance for each gene
    gene_vars <- tryCatch(
        {
            if (id_in_column) {
                message("Calculating variance for data with gene IDs in the first column")
                numeric_data <- as.matrix(data[, -1, drop = FALSE])
                if (!is.numeric(numeric_data)) {
                    message("Warning: Non-numeric data detected. Attempting to convert to numeric.")
                    numeric_data <- apply(numeric_data, 2, as.numeric)
                }
                apply(numeric_data, 1, var, na.rm = TRUE)
            } else {
                message("Calculating variance for data with gene IDs as rownames")
                numeric_data <- as.matrix(data)
                if (!is.numeric(numeric_data)) {
                    message("Warning: Non-numeric data detected. Attempting to convert to numeric.")
                    numeric_data <- apply(numeric_data, 2, as.numeric)
                }
                apply(numeric_data, 1, var, na.rm = TRUE)
            }
        },
        error = function(e) {
            message("Error in variance calculation: ", e$message)
            message("First few rows of data:")
            print(head(data))
            message("Data structure:")
            str(data)
            return(rep(NA, nrow(data)))
        }
    )

    # Convert Ensembl IDs to gene symbols if applicable
    new_gene_ids <- gene_ids
    if (is_ensembl(gene_ids)) {
        message("Converting Ensembl IDs to gene symbols...")
        stripped_gene_ids <- strip_ensembl_version(gene_ids)
        new_gene_ids <- seAMLess::grch38$symbol[match(stripped_gene_ids, seAMLess::grch38$ensgene)]
        # Replace NA values with original IDs
        new_gene_ids[is.na(new_gene_ids)] <- gene_ids[is.na(new_gene_ids)]
    }

    # Create a data frame with IDs and variances
    id_var_df <- data.frame(
        new_gene_ids = new_gene_ids,
        gene_ids = gene_ids,
        variance = gene_vars
    )

    # Sort by variance (descending) and keep only the first occurrence of each gene symbol
    id_var_df <- id_var_df[order(id_var_df$variance, decreasing = TRUE), ]
    id_var_df <- id_var_df[!duplicated(id_var_df$new_gene_ids), ]

    # Update the data with sorted and deduplicated gene symbols
    if (id_in_column) {
        data <- data[match(id_var_df$gene_ids, gene_ids), ]
        data <- data[, -1, drop = FALSE]
    } else {
        data <- data[match(id_var_df$gene_ids, gene_ids), ]
    }
    rownames(data) <- id_var_df$new_gene_ids

    return(data)
}
```


```{r}
sample_data <- read_fst("backend/cache/sample_data.fst")

sample_data <- convert_to_symbols(sample_data)
```

